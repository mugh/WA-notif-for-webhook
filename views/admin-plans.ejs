<%- include('partials/header') %>

<div class="container mx-auto px-4 py-6">
  <h2 class="text-2xl font-bold mb-6">Manage Subscription Plans</h2>
  
  <% if (typeof message !== 'undefined' && message) { %>
    <% 
      let alertClass = "bg-blue-100 border-blue-500 text-blue-700";
      if (message.type === 'success') {
        alertClass = "bg-green-100 border-green-500 text-green-700";
      } else if (message.type === 'danger') {
        alertClass = "bg-red-100 border-red-500 text-red-700";
      } else if (message.type === 'warning') {
        alertClass = "bg-yellow-100 border-yellow-500 text-yellow-700";
      }
    %>
    <div class="<%= alertClass %> px-4 py-3 rounded border-l-4 mb-6">
      <%= message.text %>
    </div>
  <% } %>
  
  <!-- Add New Plan Button -->
  <div class="mb-6">
    <button class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors" onclick="openPlanModal('new')">
      <i class="fas fa-plus mr-2"></i> Add New Plan
    </button>
  </div>
  
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="bg-gray-100 px-4 py-3 border-b">
      <h5 class="font-medium flex items-center"><i class="fas fa-tags mr-2"></i> Subscription Plans</h5>
    </div>
    <div class="p-4">
      <% if (plans && plans.length > 0) { %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan Name</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% plans.forEach(plan => { %>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap font-medium"><%= plan.name %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= plan.duration_months %> month<%= plan.duration_months > 1 ? 's' : '' %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= plan.currency %> <%= plan.price %></td>
                  <td class="px-6 py-4 whitespace-nowrap"><%= plan.description || '-' %></td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <% if (plan.active) { %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                    <% } else { %>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>
                    <% } %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <%= new Date(plan.created_at).toLocaleDateString() %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                      <button class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded transition-colors" onclick="openPlanModal('edit', '<%= plan.id %>', '<%= plan.name %>', '<%= plan.duration_months %>', '<%= plan.price %>', '<%= plan.currency %>', '<%= plan.description || '' %>', '<%= plan.active %>')">
                        <i class="fas fa-edit mr-1"></i> Edit
                      </button>
                      <form method="POST" action="/admin/plans/<%= plan.id %>/toggle" class="inline-block">
                        <button type="submit" class="inline-flex items-center <%= plan.active ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700' %> text-white text-xs py-1 px-2 rounded transition-colors">
                          <i class="fas fa-<%= plan.active ? 'pause' : 'play' %> mr-1"></i> 
                          <%= plan.active ? 'Deactivate' : 'Activate' %>
                        </button>
                      </form>
                      <button class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-2 rounded transition-colors" onclick="deletePlan('<%= plan.id %>', '<%= plan.name %>')">
                        <i class="fas fa-trash mr-1"></i> Delete
                      </button>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded">
          <i class="fas fa-info-circle mr-1"></i> No subscription plans found.
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Plan Management Modal -->
<div id="planModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
    <div class="flex items-center justify-between bg-gray-100 px-4 py-3 border-b rounded-t-lg">
      <h5 class="font-medium text-lg" id="planModalLabel">Add New Plan</h5>
      <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closePlanModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="planForm" method="POST" action="/admin/plans">
      <div class="p-4">
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Plan Name:</label>
          <input type="text" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" id="name" name="name" required>
        </div>
        
        <div class="mb-4">
          <label for="duration_months" class="block text-sm font-medium text-gray-700 mb-1">Duration (Months):</label>
          <input type="number" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" id="duration_months" name="duration_months" min="1" required>
        </div>
        
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-8">
            <div class="mb-4">
              <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price:</label>
              <input type="number" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" id="price" name="price" step="0.01" min="0" required>
            </div>
          </div>
          <div class="col-span-4">
            <div class="mb-4">
              <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency:</label>
              <select class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" id="currency" name="currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
                <option value="IDR">IDR</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description:</label>
          <textarea class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" id="description" name="description" rows="3"></textarea>
        </div>
        
        <div class="mb-4" id="activeGroup" style="display: none;">
          <div class="flex items-center">
            <input type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded" id="active" name="active">
            <label class="ml-2 block text-sm text-gray-700" for="active">
              Active
            </label>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 flex justify-end space-x-3 rounded-b-lg">
        <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors" onclick="closePlanModal()">Cancel</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition-colors" id="submitBtn">Add Plan</button>
      </div>
    </form>
  </div>
</div>

<script>
let currentMode = 'new';

function openPlanModal(mode, id = null, name = '', duration = '', price = '', currency = 'USD', description = '', active = true) {
  currentMode = mode;
  
  // Update modal title and form action
  const modalTitle = document.getElementById('planModalLabel');
  const planForm = document.getElementById('planForm');
  const submitBtn = document.getElementById('submitBtn');
  const activeGroup = document.getElementById('activeGroup');
  const modalOverlay = document.getElementById('planModalOverlay');
  
  if (mode === 'new') {
    modalTitle.textContent = 'Add New Plan';
    planForm.action = '/admin/plans';
    submitBtn.textContent = 'Add Plan';
    activeGroup.style.display = 'none';
    
    // Clear form
    document.getElementById('name').value = '';
    document.getElementById('duration_months').value = '';
    document.getElementById('price').value = '';
    document.getElementById('currency').value = 'USD';
    document.getElementById('description').value = '';
  } else {
    modalTitle.textContent = 'Edit Plan';
    planForm.action = `/admin/plans/${id}`;
    submitBtn.textContent = 'Update Plan';
    activeGroup.style.display = 'block';
    
    // Fill form
    document.getElementById('name').value = name;
    document.getElementById('duration_months').value = duration;
    document.getElementById('price').value = price;
    document.getElementById('currency').value = currency;
    document.getElementById('description').value = description;
    document.getElementById('active').checked = active === 'true' || active === true;
  }
  
  // Show modal
  modalOverlay.classList.remove('hidden');
  // Prevent scrolling when modal is open
  document.body.style.overflow = 'hidden';
}

function closePlanModal() {
  const modalOverlay = document.getElementById('planModalOverlay');
  modalOverlay.classList.add('hidden');
  // Re-enable scrolling
  document.body.style.overflow = '';
}

function deletePlan(id, name) {
  showConfirmModal(`Are you sure you want to delete the plan "${name}"? This action cannot be undone.`, function() {
    fetch(`/admin/plans/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('Plan deleted successfully', 'success');
        location.reload();
      } else {
        showToast(data.message || 'Error deleting plan', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error deleting plan', 'error');
    });
  });
}

// Close modal when clicking outside of it
document.addEventListener('DOMContentLoaded', function() {
  const modalOverlay = document.getElementById('planModalOverlay');
  const modalContent = modalOverlay.querySelector('.bg-white');
  
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      closePlanModal();
    }
  });
});
</script>

<%- include('partials/footer') %> 