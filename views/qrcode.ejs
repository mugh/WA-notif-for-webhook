<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mt-4 mb-4">
  <h2>WhatsApp QR Code</h2>
  <a href="/dashboard" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </a>
</div>

<div class="card">
  <div class="card-header">
    Scan QR Code with WhatsApp
  </div>
  <div class="card-body text-center">
    <% if (connectionStatus === 'connected') { %>
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i> WhatsApp is already connected!
      </div>
      <p>You can disconnect and reconnect with a new QR code if needed.</p>
      <a href="/disconnect" class="btn btn-danger">
        <i class="fas fa-unlink"></i> Disconnect
      </a>
    <% } else if (qrCode) { %>
      <div class="alert alert-warning">
        <strong>Important:</strong> Scan this QR code with your WhatsApp app to connect.
      </div>
      
      <div class="qr-code">
        <img src="<%= qrCode %>" alt="WhatsApp QR Code" class="img-fluid">
      </div>
      
      <p class="mt-3">This QR code will expire after a few minutes. If it expires, click the button below to generate a new one.</p>
      
      <button id="refresh-qr" class="btn btn-primary mt-2">
        <i class="fas fa-sync-alt"></i> Refresh QR Code
      </button>
    <% } else { %>
      <p>Click the button below to generate a QR code for WhatsApp connection:</p>
      <button id="generate-qr" class="btn btn-primary">
        <i class="fas fa-qrcode"></i> Generate QR Code
      </button>
      <div id="loading" class="mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Generating QR code...</p>
      </div>
    <% } %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const generateQrBtn = document.getElementById('generate-qr');
  const refreshQrBtn = document.getElementById('refresh-qr');
  const loading = document.getElementById('loading');
  
  function generateQrCode() {
    if (loading) loading.style.display = 'block';
    if (generateQrBtn) generateQrBtn.disabled = true;
    if (refreshQrBtn) refreshQrBtn.disabled = true;
    
    fetch('/api/qrcode', {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload the page after a short delay to show the new QR code
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        alert(`Error: ${data.message}`);
        if (loading) loading.style.display = 'none';
        if (generateQrBtn) generateQrBtn.disabled = false;
        if (refreshQrBtn) refreshQrBtn.disabled = false;
      }
    })
    .catch(error => {
      alert(`Error: ${error.message}`);
      if (loading) loading.style.display = 'none';
      if (generateQrBtn) generateQrBtn.disabled = false;
      if (refreshQrBtn) refreshQrBtn.disabled = false;
    });
  }
  
  if (generateQrBtn) {
    generateQrBtn.addEventListener('click', generateQrCode);
  }
  
  if (refreshQrBtn) {
    refreshQrBtn.addEventListener('click', generateQrCode);
  }
  
  // Check connection status periodically
  if (document.querySelector('.qr-code')) {
    const checkStatus = setInterval(() => {
      fetch('/api/status')
        .then(response => response.json())
        .then(data => {
          if (data.connectionStatus === 'connected') {
            clearInterval(checkStatus);
            window.location.reload();
          }
        })
        .catch(error => {
          console.error('Error checking status:', error);
        });
    }, 5000); // Check every 5 seconds
  }
});
</script>

<%- include('partials/footer') %> 